name: Latest blog post workflow
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
jobs:
  update-readme-with-blog:
    name: Update this repos README with latest blog posts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: |
          pip install feedparser requests
      - name: Update README with blog posts
        run: |
          echo "Starting Python script..."
          python - <<EOF
          import feedparser
          import requests
          import re
          from datetime import datetime
          
          print("Starting blog post fetch...")
          
          # Fetch RSS with proper User-Agent and additional headers
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'application/rss+xml, application/xml, text/xml',
              'Accept-Language': 'en-US,en;q=0.9',
              'Accept-Encoding': 'gzip, deflate, br',
              'DNT': '1',
              'Connection': 'keep-alive',
              'Upgrade-Insecure-Requests': '1',
          }
          print("Fetching RSS feed...")
          
          import time
          
          # Try multiple approaches
          urls_to_try = [
              'https://andrewcfielding.substack.com/feed',
              'https://andrewcfielding.substack.com/feed/',
          ]
          
          response = None
          for url in urls_to_try:
              try:
                  print(f"Trying URL: {url}")
                  time.sleep(2)  # Add delay
                  response = requests.get(url, headers=headers, allow_redirects=True, timeout=30)
                  print(f"Response status: {response.status_code}")
                  if response.status_code == 200:
                      break
                  else:
                      print(f"Failed with status {response.status_code}, trying next URL...")
              except Exception as e:
                  print(f"Error with {url}: {e}")
                  continue
          
          if not response or response.status_code != 200:
              print(f"All URLs failed. Last response status: {response.status_code if response else 'None'}")
              print("Trying to continue anyway...")
              
          print(f"Final response status: {response.status_code if response else 'None'}")
          print(f"Response length: {len(response.content) if response else 0} bytes")
          
          # Parse RSS
          feed = feedparser.parse(response.content)
          
          print(f"Feed title: {getattr(feed.feed, 'title', 'No title')}")
          print(f"Number of entries found: {len(feed.entries)}")
          
          # Debug: Print first few entries
          for i, entry in enumerate(feed.entries[:3]):
              print(f"Entry {i+1}: {getattr(entry, 'title', 'No title')} - {getattr(entry, 'link', 'No link')}")
          
          # Read current README
          with open('README.md', 'r') as f:
              content = f.read()
          
          print("Current README content preview:")
          print(content[:500] + "..." if len(content) > 500 else content)
          
          # Generate blog post list
          posts = []
          for entry in feed.entries[:5]:  # Latest 5 posts
              title = getattr(entry, 'title', 'Untitled')
              link = getattr(entry, 'link', '#')
              posts.append(f"- [{title}]({link})")
              print(f"Added post: {title}")
          
          if not posts:
              print("No posts found to add!")
              posts = ["- No recent posts found"]
          
          blog_section = "<!-- BLOG-POST-LIST:START -->\n" + "\n".join(posts) + "\n<!-- BLOG-POST-LIST:END -->"
          
          print("Generated blog section:")
          print(blog_section)
          
          # Replace or add blog section
          if "<!-- BLOG-POST-LIST:START -->" in content:
              print("Found existing blog section, replacing...")
              content = re.sub(r'<!-- BLOG-POST-LIST:START -->.*?<!-- BLOG-POST-LIST:END -->', blog_section, content, flags=re.DOTALL)
          else:
              print("No existing blog section found, appending...")
              content += "\n\n" + blog_section
          
          # Write updated README
          with open('README.md', 'w') as f:
              f.write(content)
          
          print("Python script completed!")
          EOF
          echo "Python script finished."
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "Updated blog posts"
          git push